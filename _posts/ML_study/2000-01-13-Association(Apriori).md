---
layout: post
title: Association(Apriori)
description: Association Analysis with Apriori
image:
use_math: true
ml: True
---

> 연관 분석
>
> 장바구니 분석
>
> 지지도, 신뢰도, 향상도

### 연관규칙 분석

연관 규칙 분석은 데이터들의 집합에서 항목들간에 숨겨진 유용한 관계를 찾아내는 분석이다. 마케팅에서의 장바구니 분석이라고 알려져 있으며, 결과를 토대로 마케팅, 재고관리 등의 다양한 비즈니스에 활용될 수 있다.

예를 들어 아래와 같은 구매목록이 있을때, 우리는 Beer와 Diapers가 같이 구매되는것이 빈번하게 발생함을 알 수있다.

> $$
> \begin{bmatrix}
> id & Bought\;Items\\
> 1 & Bread,\;milk\\
> 2 & Bread,\;Diapers,\;Beer,\;Eggs\\
> 3 & Milk,\;Diapers,\;Beer,\;Coke\\
> 4 & Bread,\;Milk,\;Diapers,\;Beer\\
> 5 & Bread,\;Milk,\;Diapers,\;Coke
> \end{bmatrix}
> $$



하지만 데이터가 많을경우 특정 규칙이 우연인지 아닌지, 어느정도로 규칙이 믿을만한지 등을 객관적인 수치로 표현하기는 난해하며, 한눈에 전체 항목이 들어오지 않기에 찾기가 매우 힘들다.

이러한 문제에 대하여 연관 규칙 분석의 경우 지지도, 신뢰도, 향상도의 개념을 이용하여 규칙을 찾아내고, 해당 규칙이 얼마나 믿을만한지에 대한 정량적 수치를 제공한다.

&nbsp;

### 지지도, 신뢰도, 향상도

#### 1. 지지도(Support)

- 지지도 카운트는 특정 종목 집합을 포함하는 데이터의 개수이다. 예를 들어 위의 구매목록의 경우 {Milk, Diapers}의 지지도 카운트는 3이다.

> $$
> 지지도\;카운트\;=\;\sigma(X)\\
> \;\\
> \;X\;=\;{Milk}\;,\;Y\;=\;Diapers\;\to\;
> \sigma(X)\;=\;4\;\;\;\;\sigma(Y)\;=\;4\;\;\;\;\sigma(X\cup Y)\;=\;3
> $$

- 연관 규칙은 $X\;\to\;Y$로 표시하며 지지도는 아래와 같이 계산가능하다.

> $$
> 지지도(support)\;:\;s(X\to Y)\;=\;\frac{\sigma(X\cup Y)}{N}\;\;\;\;\;\;\;\;\;\;N=len(data)
> $$

- 지지도는 한 규칙이 주어진 데이터 집합에 얼마나 자주 나타나는지에 대한 수치이며, 지지도가 낮을수록 한 규칙이 우연히 발생할 가능성이 높아진다. (전체 거래 내역중 X와 Y가 함께 구매된 비율)

- 지지도는 규칙의  선후 관계가 고려되지 않는다. 즉 동일 데이터 집합 상에서의 $s(Milk \to Diapers)$와 $s(Diapers \to Milk)$는 동일한 지지도를 갖는다.

&nbsp;

#### 2. 신뢰도(Confidence)

- 신뢰도는 전체 집합을 대상으로 특정 규칙의 빈도를 측정하는것과 다르게 X를 포함한 집합을 대상으로 Y가 X와 함께 등장하는 빈도를 측정한다. (X가 구매된 내역중 Y가 함께 구매된 비율)
- 즉 신뢰도는 주어진 X에서 Y의 조건 확률에 대한 추정값이다. 이에따라 지지도와는 다르게 $s(Milk \to Diapers)$와 $s(Diapers \to Milk)$는 서로 다른 신뢰도를 갖는다.

> $$
> 신뢰도(Confidence)\;:\;c(X\to Y)\;=\;\frac{\sigma(X \cup Y)}{\sigma(X)}
> $$

- 단, 연관규칙에 의해 만들어진 추론은 반드시 인과관계를 담고있는것은 아니다. 다만 X와 Y간의 강한 동시발생 관계를 제시할뿐이다.

&nbsp;

#### 3. 향상도(Lift)

- 연관규칙을 파악하다 보면 $X\to Y$라는 규칙에 상관없이 원래 Y가 많이 나올 수도 있다. 만약 어떤 품목 Y가 모든 거래내역에 포함되어 있다면, X에 어떠한 품목이 오던지 신뢰도가 높게 측정될 것이다. 이러한 경우, $X\to Y$라는 규칙은 의미가 없다.
- 향상도는 이러한 신뢰도의 문제점을 개선하기 위하여 Y에 대한 빈도 역시 고려하는 수치이다.

> $$
> 향상도(Lift)\;:\;Lift(X\to Y)\;=\;\frac{c(X\to Y)}{s(Y)}\;=\;\frac{s(X\cup Y)}{s(X)\cdot s(Y)}
> $$

- 향상도는 위처럼 신뢰도를 Y가 발생한 비율로 나눠준 척도이다. Y가 많이 발생할 수록 향상도는 낮아진다.
- 향상도는 1을 중심으로 1보다 크면 양의 상관성을, 1보다 작으면 음의 상관성을 갖으며, 1일경우 서로 독립적이라는 의미이다.

&nbsp;

&nbsp;

### Apriori

- 데이터에서 연관규칙을 찾는다는 의미는 지지도, 신뢰도, 향상도가 임계치 이상인 모든 규칙을 찾는다는것을 의미한다. 

- 이를위한 가장 쉬운방법으로는 발생 가능한 모든 조합에 대한 규칙을 만들고 이에 대한 수치를 모두 계산하는 것이다(Brute Force방식). 그러나, 이방식의 경우 아이템이 한개 증가할 때마다 가능한 조합의 개수가 기하급수적으로 증가하기에 효율적이지 못하다는 문제점이 있다.

- 이러한 문제를 해결하기 위해 등장한 알고리즘이 Apriori 알고리즘이다.

&nbsp;

#### Apriori 기본 아이디어

- 지지도는 앞서 설명하였듯이 $(X \cup Y)$에만 의존함(선후관계고려 X)으로 부분집합이 같으면 지지도는 모두 동일하다. 
- 만약 $(X \cup Y)$가 빈번하지 않다면, 즉 지지도가 낮다면 이 조합들의 신뢰도는 계산할 필요가 없다. $\to$ 계산해야할 조합이 줄어든다.

&nbsp;

#### 알고리즘의 절차

- 빈발 항목 생성
  - 지지도 임계치를 만족하는 모든 항목 집합을 찾는다. 이것을 빈발 항목 집합이라고 한다.
  - 이때 빈발 항목 집합을 줄이는 것이 관건이다.
- 규칙생성
  - 빈발 항목 집합에 대해 신뢰도나 향상도가 높은 규칙을 추출한다.
- 지지도 기반 가지치기
  - 만약 한 항목 집합이 빈발하면, 그것의 모든 부분집합들 역시 빈발하다. 
  - 따라서 빈발항목 집합에 불필요한 부분 집합이 포함되지 않도록 지지도를 기준으로 가지치기 한다.

&nbsp;

#### - 예시 -

<center><img src="{{ "/assets/images/Association/Apriori_1.PNG" | absolute_url }}" width = 'auto' height = 'auto' alt="" /></center>

- 위 그림은 a, b, c, d 품목으로 구성된 모든 부분 집합이다.
- 모든 부분집합으로 후보 규칙을 생성해볼 수 있다. (Brute Force)

> $$
> \{a\}\to\{a,b\},\;\;\;{a}\to\{a,c\},\;\;\;\{a\}\to\{a,d\}\;\cdots
> $$

- 생성결과 조합이 너무 많다. (연산량이 너무 많다) $\to$ 조합을 줄여야 한다. 

- 만약 {b, c, d}가 빈발하다면, 그 부분집합 또한 모두 빈발하다.
  - A 영역내의 모든 경우가 전부 빈발하다.
- 만약 {a, b}가 빈발하지 않다면 (지지도 임계치보다 낮다면) {a, b}를 포함하는 모든 조합역시 빈발하지 않다.
  - B 영역내의 모든 경우가 전부 빈발하지 않다.
  - 이들에 대한 지지도를 계산할 필요가 없다. $\to$ 후보 빈발항목 집합 제외 가능 (가지치기)
- 조합의 개수가 줄어들었다!

&nbsp;

&nbsp;

&nbsp;

### Practice (Python)

[Online Retail Data](https://github.com/Hyunjun-Bruce-Lee/ML_study/blob/master/Association/apriori(Online_Retail).py)

